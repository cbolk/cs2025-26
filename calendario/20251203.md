---
exe-start: 47
exepro-start: 58
---

# Python: data visualisation

+ matplot
    + line
    + bar
    + grouped bar
    + histogram

## Exercises in class

## Loading data

```Python
import pandas as pd
from datetime import datetime, timedelta
import matplotlib.pyplot as plt
from matplotlib.ticker import MaxNLocator


PATIENTS_FILE = "files/pd.trials.patient.csv"
TREATMENTS_FILE = "files/pd.trials.treatment.csv"
PAT_TREA_FILE = "files/pd.trials.patient_treatment.csv"
RESULTS_FILE = "files/pd.trials.lab_result.csv"

dfp = pd.read_csv(PATIENTS_FILE)
dft = pd.read_csv(TREATMENTS_FILE)
dfpt = pd.read_csv(PAT_TREA_FILE)
dfout = pd.read_csv(RESULTS_FILE)

# set dates with the appropriate type
dfp['EnrollDate'] = pd.to_datetime(dfp['EnrollDate'])
dfpt['StartDate'] = pd.to_datetime(dfpt['StartDate'])
dfout['VisitDate'] = pd.to_datetime(dfout['VisitDate'])

```

## Queries - in class

### Q. Ask the user to select a PID and report and create a chart with their weight in subsequent visits
I added code to handle the user input, to make sure the values are within the existing range

```Python
# ask the user for a valid PID in the existing range
PIDfrom = dfp[['PID']].min()
PIDto = dfp[['PID']].max()
print(f'PID ([{PIDfrom.iloc[0]}, {PIDto.iloc[0]}])')
selPID = int(input())
while selPID not in dfp['PID'].values::
    print(f'PID ([{PIDfrom.iloc[0]}, {PIDto.iloc[0]}])')
    selPID = int(input())

# get lab results for the selected PID
dfresp = dfout[dfout.PID == selPID]

dfresp_plot = dfresp.pivot(
    index="VisitDate",
    columns="TestName",
    values="Value"
).sort_index()

# PLOT
plt.figure(figsize=(8, 4))

# Plot LDL as an example
plt.plot(dfresp_plot.index, dfresp_plot["LDL"], marker='o', label=col)
plt.title(f"Lab values over time for patient {selPID}")
plt.xlabel("Visit date")
plt.ylabel("Value")
plt.xticks(rotation=45)
plt.legend()
plt.tight_layout()
plt.show()

# Plot all available tests as separate lines
plt.figure(figsize=(8, 4))
for col in dfresp_plot.columns:
    plt.plot(dfresp_plot.index, dfresp_plot[col], marker='o', label=col)

plt.title(f"Lab values over time for patient {selPID}")
plt.xlabel("Visit date")
plt.ylabel("Value")
plt.xticks(rotation=45)
plt.legend()
plt.tight_layout()
plt.show()
```

### Q. How many patients have enrolled per month?

```Python
# identify the month
dfp["EnrollMonth"] = dfp['EnrollDate'].dt.to_period('M')

# group by site, month
enroll_counts = dfp.groupby('EnrollMonth')['PID'].count().reset_index(name='NumPatients')

# Fix column type
enroll_counts["EnrollMonth_str"] = enroll_counts["EnrollMonth"].astype(str)


plt.figure(figsize=(6, 4))
plt.bar(enroll_counts["EnrollMonth_str"], enroll_counts["NumPatients"])

plt.title("Number of patients enrolled per month")
plt.xlabel("Month")
plt.ylabel("Number of patients")
plt.xticks(rotation=45)
plt.tight_layout()
plt.show()
```

Fix float number of patients


```Python
plt.figure(figsize=(6,4))
plt.bar(enroll_counts["EnrollMonth_str"], enroll_counts["NumPatients"])

plt.title("Number of patients enrolled per month")
plt.xlabel("Month")
plt.ylabel("Number of patients")

ax = plt.gca()
ax.yaxis.set_major_locator(MaxNLocator(integer=True))

plt.xticks(rotation=45)
plt.tight_layout()
plt.show()
```

### Q. How many patients have enrolled per site per month?

```Python
# identify the month
dfp["EnrollMonth"] = dfp['EnrollDate'].dt.to_period('M')

# group by site, month
enroll_counts = dfp.groupby(['SiteID', 'EnrollMonth'])['PID'].count().reset_index()

# Better column name
enroll_counts.rename(columns={'PID': 'NumPatients'}, inplace=True)


plot_df = enroll_counts.pivot(
    index='EnrollMonth',
    columns='SiteID',
    values='NumPatients'
).fillna(0)


plot2_df = enroll_counts.pivot(
    index='SiteID',
    columns='EnrollMonth',
    values='NumPatients'
).fillna(0)

# PER SITE

ax = plot_df.plot(kind='bar', figsize=(10,6))

plt.xlabel("Enrollment Month")
plt.ylabel("Number of Patients")
plt.title("Patients Enrolled Per Site Per Month")
plt.xticks(rotation=45)
plt.tight_layout()
plt.show()

## stacked

ax = plot_df.plot(kind='bar', stacked=True, figsize=(10, 6))

plt.xlabel("Enrollment Month")
plt.ylabel("Number of Patients")
plt.title("Patients Enrolled per Site per Month (Stacked)")
plt.xticks(rotation=45)
plt.tight_layout()
plt.show()

## line

ax = plot_df.plot(kind='line', figsize=(10,6))

plt.xlabel("Enrollment Month")
plt.ylabel("Number of Patients")
plt.title("Patients Enrolled Per Site Per Month")
plt.xticks(rotation=45)
plt.tight_layout()
plt.show()


# PER MONTH

ax = plot2_df.plot(kind='bar', figsize=(10,6))

plt.xlabel("Site")
plt.ylabel("Number of Patients")
plt.title("Patients Enrollment Per Month Per Site")
plt.xticks(rotation=45)
plt.tight_layout()
plt.show()
```

### Q. Plot the age distribution of the enrolled patients


```Python
plt.figure(figsize=(7, 4))
plt.hist(dfp["Age"], bins=10)

plt.title("Age distribution of enrolled patients")
plt.xlabel("Age")
plt.ylabel("Number of patients")
plt.tight_layout()
plt.show()
```



