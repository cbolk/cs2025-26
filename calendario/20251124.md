---
exe-start: 47
exepro-start: 58
---

# Python: data manipulation

+ pandas
    - data loading 
    - filtering (selecting rows/columns)
    - combining data from different dataframes (merging)
    - clustering into groups (grouping)

## Exercises in class


## Dataset

1. `patient`: Patient information

| Column        | Type   | Description                         |
| ------------- | ------ | ----------------------------------- |
| PID           | Int    | Unique identifier for the patient   |
| Age           | Int    | Age of the patient at enrollment    |
| Sex           | String | Biological sex ('M' or 'F')         |
| SiteID        | String | Code for the hospital/clinic        |
| EnrollDate    | Date   | The date the patient signed         |

Sample Data:

| PID | Age | Sex | SiteID | EnrollDate |
| :--- | :--- | :--- | :--- | :--- |
| 101 | 55 | M | NY-01 | 2023-01-10 |
| 102 | 62 | F | LON-05 | 2023-01-12 |
| 103 | 44 | M | NY-01 | 2023-01-15 |


2. `treatment`: This describes the drugs conceptually.

| Column        | Type   | Description                                                           |
| ------------- | ------ | --------------------------------------------------------------------- |
| TrtID         | Int    | Treatment ID                                                          |
| DrugName      | String | The treatment administered: 'Metabolix', 'StandardCare', or 'Placebo' |
| StudyArm      | String | Protocol type: 'Experimental', 'ActiveControl', or 'PlaceboControl'   |


Sample Data:

| TrtID | DrugName | StudyArm |
| :--- | :--- | :--- |
| T01 | Metabolix | Experimental |
| T02 | StandardCare | Control |
| T03 | Placebo | PlaceboControl |


3. `patient_treatment`: This table links the patient and the treatment it is associated with, and specifies the prescription.

| Column        | Type   | Description                                                           |
| ------------- | ------ | --------------------------------------------------------------------- |
| PID           | Int    | Patient ID                                                            |
| TrtID         | Int    | Treatment ID                                                          |
| StartDate     | Date   | The date the patient started taking the medication                    | 
| Dosage_mg     | Int    | Daily dosage in milligrams (e.g., 10, 20, 50)                         |


Sample Data:

| PID  | TrtID|  StartDate  | Dosage_mg |
| :--- | :--- | :--- | :--- |
|101   | T01  |2023-01-15   | 20
|102   | T03  |2023-01-20   | 0


4. `lab_result` This table contains longitudinal data (measurements taken over time). 

| Column        | Type   | Description                                                              |
| ------------- | ------ | ------------------------------------------------------------------------ |
| LabID         | Int    | Unique identifier for the specific lab test instance                     |
| PID           | Int    | Foreign key linking to the patient                                       |
| VisitDate     | Date   | The date the measurement was taken                                       |
| TestName      | String | The type of metric measured ('HbA1c', 'Systolic_BP', 'LDL', 'Weight_kg') |
| Value         | Float  | The numerical result of the measurement                                  |


Sample Data:

| LabID | PID | VisitDate | TestName | Value |
| :--- | :--- | :--- | :--- | :--- |
| 1 | 101 | 2023-01-10 | HbA1c | 7.2 |
| 2 | 101 | 2023-01-10 | Weight_kg | 88.5 |
| 3 | 101 | 2023-02-10 | HbA1c | 6.9 |
| 4 | 102 | 2023-01-12 | Systolic_BP | 140.0 |


## Visual relationships

![Data relationships](./images/pd.trials.png)

## Loading data

```Python
import pandas as pd
from datetime import datetime, timedelta


PATIENTS_FILE = "files/pd.trials.patient.csv"
TREATMENTS_FILE = "files/pd.trials.treatment.csv"
PAT_TREA_FILE = "files/pd.trials.patient_treatment.csv"
RESULTS_FILE = "files/pd.trials.lab_result.csv"

dfp = pd.read_csv(PATIENTS_FILE)
dft = pd.read_csv(TREATMENTS_FILE)
dfpt = pd.read_csv(PAT_TREA_FILE)
dfout = pd.read_csv(RESULTS_FILE)

# set dates with the appropriate type
dfp['EnrollDate'] = pd.to_datetime(dfp['EnrollDate'])
dfpt['StartDate'] = pd.to_datetime(dfpt['StartDate'])
dfout['VisitDate'] = pd.to_datetime(dfout['VisitDate'])

```

## Queries - in class

### Q. Find all patients age higher or equal to 40 (row filtering)

```Python
df_res = dfp[dfp.Age >= 40]
# alternative writing style
df_res = dfp[dfp["Age"] >= 40]
# alternative use of a variable
filter_criteria = (dfp.Age >= 40)
df_res = dfp[filter_criteria]
```

### Q. Report patient ID, Age and Sex of the enrolled patients (column selection)
```Python
dfp[['PID', 'Age', 'Sex']]
```

### Q. Find all IDs of patients age higher or equal to 40

```Python
df_res = dfp[dfp.Age >= 40][['PID']]
```

### Q. Find all *female* patients age higher or equal to 40
```Python
df_res = dfp[(dfp.Age >= 40) & (dfp.Sex == 'F')] ## not and
```

### Q. Find all patients age 40 or age 55
```Python
df_res = dfp[(dfp.Age == 40) | (dfp.Age == 55)] ## not or
```

### Combine patients and treatments 
```Python
dfpattreat = pd.merge(dfp, dfpt, on='PID', how='left')
```

### add information on the treatment 
```Python
dfpattreatdrug = pd.merge(dfpattreat, dft, on='TrtID', how='left')
```

### Q. Compute the average age of males and females across all trials

```Python
dfp.groupby(['Sex'])['Age'].mean().reset_index()
```
> see the difference between using `.reset_index()` or not

### Q. Compute the average age of males and females for each site

```Python
dfp.groupby(['SiteID', 'Sex'])['Age'].mean().reset_index()
```
> see the difference between using `.reset_index()` or not


