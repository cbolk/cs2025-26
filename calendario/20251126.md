---
exe-start: 47
exepro-start: 58
---

# Python: data manipulation

+ pandas
    - data loading 
    - filtering (selecting rows/columns)
    - combining data from different dataframes (merging)
    - clustering into groups (grouping)

## Exercises in class


## Dataset

1. `patient`: Patient information

| Column        | Type   | Description                         |
| ------------- | ------ | ----------------------------------- |
| PID           | Int    | Unique identifier for the patient   |
| Age           | Int    | Age of the patient at enrollment    |
| Sex           | String | Biological sex ('M' or 'F')         |
| SiteID        | String | Code for the hospital/clinic        |
| EnrollDate    | Date   | The date the patient signed         |

Sample Data:

| PID | Age | Sex | SiteID | EnrollDate |
| :--- | :--- | :--- | :--- | :--- |
| 101 | 55 | M | NY-01 | 2023-01-10 |
| 102 | 62 | F | LON-05 | 2023-01-12 |
| 103 | 44 | M | NY-01 | 2023-01-15 |


2. `treatment`: This describes the drugs conceptually.

| Column        | Type   | Description                                                           |
| ------------- | ------ | --------------------------------------------------------------------- |
| TrtID         | Int    | Treatment ID                                                          |
| DrugName      | String | The treatment administered: 'Metabolix', 'StandardCare', or 'Placebo' |
| StudyArm      | String | Protocol type: 'Experimental', 'ActiveControl', or 'PlaceboControl'   |


Sample Data:

| TrtID | DrugName | StudyArm |
| :--- | :--- | :--- |
| T01 | Metabolix | Experimental |
| T02 | StandardCare | Control |
| T03 | Placebo | PlaceboControl |


3. `patient_treatment`: This table links the patient and the treatment it is associated with, and specifies the prescription.

| Column        | Type   | Description                                                           |
| ------------- | ------ | --------------------------------------------------------------------- |
| PID           | Int    | Patient ID                                                            |
| TrtID         | Int    | Treatment ID                                                          |
| StartDate     | Date   | The date the patient started taking the medication                    | 
| Dosage_mg     | Int    | Daily dosage in milligrams (e.g., 10, 20, 50)                         |


Sample Data:

| PID  | TrtID|  StartDate  | Dosage_mg |
| :--- | :--- | :--- | :--- |
|101   | T01  |2023-01-15   | 20
|102   | T03  |2023-01-20   | 0


4. `lab_result` This table contains longitudinal data (measurements taken over time). 

| Column        | Type   | Description                                                              |
| ------------- | ------ | ------------------------------------------------------------------------ |
| LabID         | Int    | Unique identifier for the specific lab test instance                     |
| PID           | Int    | Foreign key linking to the patient                                       |
| VisitDate     | Date   | The date the measurement was taken                                       |
| TestName      | String | The type of metric measured ('HbA1c', 'Systolic_BP', 'LDL', 'Weight_kg') |
| Value         | Float  | The numerical result of the measurement                                  |


Sample Data:

| LabID | PID | VisitDate | TestName | Value |
| :--- | :--- | :--- | :--- | :--- |
| 1 | 101 | 2023-01-10 | HbA1c | 7.2 |
| 2 | 101 | 2023-01-10 | Weight_kg | 88.5 |
| 3 | 101 | 2023-02-10 | HbA1c | 6.9 |
| 4 | 102 | 2023-01-12 | Systolic_BP | 140.0 |


## Visual relationships

![Data relationships](./images/pd.trials.png)

## Loading data

```Python
import pandas as pd
from datetime import datetime, timedelta


PATIENTS_FILE = "files/pd.trials.patient.csv"
TREATMENTS_FILE = "files/pd.trials.treatment.csv"
PAT_TREA_FILE = "files/pd.trials.patient_treatment.csv"
RESULTS_FILE = "files/pd.trials.lab_result.csv"

dfp = pd.read_csv(PATIENTS_FILE)
dft = pd.read_csv(TREATMENTS_FILE)
dfpt = pd.read_csv(PAT_TREA_FILE)
dfout = pd.read_csv(RESULTS_FILE)

# set dates with the appropriate type
dfp['EnrollDate'] = pd.to_datetime(dfp['EnrollDate'])
dfpt['StartDate'] = pd.to_datetime(dfpt['StartDate'])
dfout['VisitDate'] = pd.to_datetime(dfout['VisitDate'])

```

## Queries - in class

### Q. Show all the trials started in March, reporting ID and starting date in a sorted way with respect to starting date.

```Python
dfpt[dfpt['StartDate'].dt.month == 3].sort_values('StartDate', ascending=True).reset_index(drop=True)[['TrtID','StartDate']]
```

### Q. Show the complete list of all enrolled patients, showing their ID, sex, and the name of the drug they were assigned to.

Expected outcome:

```
PID Sex      DrugName
101   M     Metabolix
102   F  StandardCare
103   F       Placebo
104   M     Metabolix
```

```Python
# let us combine patients and their trial information
dfptreat = pd.merge(dfp, dfpt, on='PID')
# adding also the information on the treatment
dffull = pd.merge(dfptreat, dft, on='TrtID')

result = dffull[['PID', 'Sex', 'DrugName']]
```

### Q. Identify all patients over the age of 60 who were assigned to the _Metabolix_ protocol, reporting their IDs and ages.

```python
dffull[(dffull.Age > 60) & (dffull.DrugName == 'Metabolix')][['PID','Age']]
```

This solution requires two steps:
1. Row filtering: a temporary intermediate copy of the DataFrame containing all the columns is created for the matching rows
2. Column selection: the temporary DataFrame is sliced to keep only the two columns

Alternative solution:

```python
dffull.loc[
    (dffull.Age > 60) & (dffull.DrugName == 'Metabolix'), 
    ['PID', 'Age']
]
```

Single Access: it only extracts the specific data points (intersection of those rows and those columns).

### Q. Check the prescriptions at the New York (_NY-01_) site: list every patient in that site showing which drug they are on and the dosage they were prescribed.

```python
dffull.loc[
    (dffull.SiteID == 'NY-01'), 
    ['PID', 'DrugName','Dosage_mg']
]
```

### Q. Verify the randomization for the _Placebo_ group: retrieve the number of females and males in such a group (create two variables numPlaM and numPlaF and print them).


```python
numPlaMF = dffull.loc[
    (dffull.DrugName == 'Placebo'), 
    ['Sex']
].value_counts()

# it returns an array with names
'''
Sex
M      8
F      2
Name: count, dtype: int64
'''

numPlaM = numPlaMF['M']
numPlaF = numPlaMF['F']

```

Alternative solution

```python
# Get gender distribution in Placebo group
numPlaMF = (
    dffull[dffull['DrugName'] == 'Placebo']         # Filter for Placebo drug
    ['Sex']                                         # Select only Sex column
    .value_counts()                                 # Count occurrences of each sex
    .sort_index()                                   # Sort by Sex (F, M)
)

```

### Q. What is the average _Systolic Blood Pressure_ (TestName is _Systolic_BP_) across the entire study population, regardless of what drug they are on?

```python
# separate mask to filter rows
bpmask = (dfout['TestName'] == 'Systolic_BP')

# creating an intermediate dataFrame

dfbp = dfout[bpmask]
avgBloodPressure = dfbp['Value'].mean()

#or 

dfbp = dfout.loc[bpmask]
avgBloodPressure = dfbp['Value'].mean()

# we do not really need the intermediate dataframe
# without creating an intermediate dataframe
avgBloodPressure = dfout.loc[bpmask,'Value'].mean()

```

### Q. Compare the three study arms. What is the average _HbA1c_ level for the _Metabolix_ group, compared to _StandardCare_ and the _Placebo_ group

Method:

1. **Split** data into groups (by Drug).
2. **Apply** a function (Mean).
3. **Combine** the results into a new table.


```python
# 0. Combine treatments and lab_results for the same patient
dftpout = pd.merge(dfpt, dfout, on='PID')
dftpout = pd.merge(dftpout, dft, on='TrtID')


# 1. Filter: Select only HbA1c records
df_hba1c = dftpout.loc[dftpout.TestName == 'HbA1c']

# 2. GroupBy: Calculate the mean value per Drug
# syntax: df.groupby('Grouping_Column')['Math_Column'].mean()
dfres = df_hba1c.groupby('DrugName')['Value'].mean().reset_index(name='avgHbA1c')
```

### Q. What is the single _highest LDL value_ recorded for any patient on the _Experimental_ protocol?

```python
# Define the protocol you are looking for (e.g., 'Experimental', 'ActiveControl', or 'PlaceboControl')
protocol = 'Experimental'

# Filter dftpout for:
# 1. The specific TestName ('LDL')
# 2. The specific StudyArm
highest_ldl = dftpout[
    (dftpout['TestName'] == 'LDL') & 
    (dftpout['StudyArm'] == protocol)
]['Value'].max()

```

### Q. List all lab results (ID, Test, Value, Date) that were taken _before_ the patient's medication Start Date, this sets the baseline data

1. We need to bring the StartDate (from the treatment table) onto the results table so that every lab row has a "reference date" to compare against -> merge
2. Keep rows where VisitDate < StartDate -> filter

```python
mask = (dftpout['VisitDate'] < dftpout['StartDate'])

baseline_data = dftpout.loc[
    mask, 
    ['LabID', 'TestName', 'Value', 'VisitDate', 'StartDate']
]

print(baseline_data.head())
```

### Q. Calculate the average number of days between a patient's _Enrollment Date_ and their treatment _Start Date_, by _Site ID_.

1. Join patients (Enroll Date & Site) with patient_treatment (Start Date) -> merge (`dffull`)
2. Create a new column called deltaTime by subtracting EnrollDate from StartDate and extract the number of days.
3. Group by SiteID and average the numbers -> `group by` and `average`


```python
dffull['deltaTime'] = dffull['StartDate'] - dffull['EnrollDate']
dffull['deltaDays'] = dffull['deltaTime'].dt.days

# also in a single step
dffull['deltaDays'] = (dffull['StartDate'] - dffull['EnrollDate']).dt.days
# group and average
dfDeltaDays = dffull.groupby('SiteID')['deltaDays'].mean().reset_index(name='avgDeltaDays')
```

### Q. When looking at _Metabolix_ users specifically, is there a difference in average _Weight_ between Male and Female patients in that group?

`Metabolix` is the `DrugName` for the patients we are interested in. For those data, we need to compute the average `Weight_kg` for the different groups based on `Sex`.

```python
# Merge dftout with dfp to have also the sex information
dfall = pd.merge(dftpout, dfp, on='PID')

# Filter the data for:
#  - DrugName: 'Metabolix'
#  - TestName: 'Weight_kg'
metabolix_weight = dfall[
    (dfall['DrugName'] == 'Metabolix') & 
    (dfall['TestName'] == 'Weight_kg')
]

# Group by Sex and calculate the average (mean) Value
avgWeight = metabolix_weight.groupby('Sex')['Value'].mean()

```

### Q. List patient IDs for anyone who has ever recorded a _Systolic BP > 160_ OR an _LDL > 150_ at any point in the study

```python
# selection based on 
# Condition 1: Test is Systolic_BP AND Value is > 160
# OR (|)
# Condition 2: Test is LDL AND Value is > 150
highRisk_filter = (
    ((dftpout['TestName'] == 'Systolic_BP') & (dftpout['Value'] > 160)) | 
    ((dftpout['TestName'] == 'LDL') & (dftpout['Value'] > 150))
)

# Apply the filter to get the rows, select the PID column, 
# and get unique values (so a patient isn't listed twice)
fdrisk = list(dftpout.loc[highRisk_filter, 'PID'].unique())

```

